<%- include('../partials/header') %>

<div class="page-header">
  <div>
    <h2><i class="bi bi-gear me-2"></i>Manage Issues</h2>
    <p class="text-muted"><%= total %> issues found</p>
  </div>
</div>

<!-- Filters -->
<div class="card card-glass p-3 mb-4">
  <form method="GET" action="/admin/issues" class="row g-2 align-items-end">
    <div class="col-sm-3">
      <label class="form-label small fw-semibold">Status</label>
      <select name="status" class="form-select form-select-sm">
        <option value="">All Statuses</option>
        <% ['Reported','Verified','In Progress','Resolved','Rejected'].forEach(s => { %>
        <option value="<%= s %>" <%= filters.status === s ? 'selected' : '' %>><%= s %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-sm-3">
      <label class="form-label small fw-semibold">Category</label>
      <select name="category" class="form-select form-select-sm">
        <option value="">All Categories</option>
        <% ['Pothole','Garbage','Water Leakage','Damaged Road','Broken Streetlight','Sewage','Encroachment','Other'].forEach(c => { %>
        <option value="<%= c %>" <%= filters.category === c ? 'selected' : '' %>><%= c %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-sm-2">
      <label class="form-label small fw-semibold">Area</label>
      <input type="text" name="area" class="form-control form-control-sm" value="<%= filters.area || '' %>" placeholder="Search area...">
    </div>
    <div class="col-sm-2">
      <label class="form-label small fw-semibold">Sort By</label>
      <select name="priority" class="form-select form-select-sm">
        <option value="">Date (Latest)</option>
        <option value="high" <%= filters.priority === 'high' ? 'selected' : '' %>>Priority (High)</option>
      </select>
    </div>
    <div class="col-sm-2 d-flex gap-1">
      <button type="submit" class="btn btn-primary btn-sm flex-fill">
        <i class="bi bi-filter me-1"></i>Filter
      </button>
      <a href="/admin/issues" class="btn btn-outline-secondary btn-sm">Reset</a>
    </div>
  </form>
</div>

<!-- Issues Table -->
<div class="card card-glass">
  <div class="table-responsive">
    <table class="table table-hover mb-0 admin-table">
      <thead>
        <tr>
          <th>Issue ID</th>
          <th>Title</th>
          <th>Category</th>
          <th>Area</th>
          <th>Reporter</th>
          <th>Severity</th>
          <th>Priority</th>
          <th>Status</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if (issues.length === 0) { %>
        <tr><td colspan="10" class="text-center py-4 text-muted">No issues found</td></tr>
        <% } %>
        <% issues.forEach(issue => { %>
        <tr class="<%= issue.isSpam ? 'table-danger' : '' %>">
          <td><code class="small"><%= issue.issueId %></code></td>
          <td>
            <a href="/issues/<%= issue._id %>" class="fw-semibold text-decoration-none">
              <%= issue.title.substring(0,35) %><%= issue.title.length > 35 ? 'â€¦' : '' %>
            </a>
            <% if (issue.isSpam) { %><span class="badge bg-danger ms-1">SPAM</span><% } %>
          </td>
          <td><span class="badge bg-secondary small"><%= issue.category %></span></td>
          <td><small><%= issue.area %></small></td>
          <td><small><%= issue.reportedBy ? issue.reportedBy.name : 'Unknown' %></small></td>
          <td>
            <div class="d-flex gap-1">
              <% for(let i=1; i<=5; i++) { %>
              <span class="sev-dot-sm <%= i <= issue.severity ? 'active' : '' %>"></span>
              <% } %>
            </div>
          </td>
          <td>
            <span class="priority-badge priority-<%= issue.priorityScore >= 40 ? 'critical' : issue.priorityScore >= 25 ? 'high' : issue.priorityScore >= 15 ? 'medium' : 'low' %>">
              <%= issue.priorityScore %>
            </span>
          </td>
          <td>
            <span class="status-badge status-<%= issue.status.toLowerCase().replace(/\s+/g,'-') %>">
              <%= issue.status %>
            </span>
          </td>
          <td><small><%= new Date(issue.createdAt).toLocaleDateString('en-IN', {day:'numeric',month:'short'}) %></small></td>
          <td>
            <div class="d-flex gap-1">
              <button class="btn btn-xs btn-outline-primary" data-bs-toggle="modal"
                      data-bs-target="#statusModal" onclick="setIssue('<%= issue._id %>', '<%= issue.status %>')">
                Update
              </button>
              <% if (!issue.isSpam) { %>
              <form action="/admin/issues/<%= issue._id %>/spam?_method=PUT" method="POST" class="d-inline">
                <input type="hidden" name="_method" value="PUT">
                <button class="btn btn-xs btn-outline-danger" onclick="return confirm('Mark as spam?')">Spam</button>
              </form>
              <% } %>
            </div>
          </td>
        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <% if (totalPages > 1) { %>
  <div class="card-footer bg-transparent">
    <nav><ul class="pagination justify-content-center mb-0 pagination-sm">
      <% for(let i=1; i<=totalPages; i++) { %>
      <li class="page-item <%= i===currentPage ? 'active' : '' %>">
        <a class="page-link" href="?page=<%= i %>&status=<%= filters.status||'' %>&category=<%= filters.category||'' %>&area=<%= filters.area||'' %>"><%= i %></a>
      </li>
      <% } %>
    </ul></nav>
  </div>
  <% } %>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-arrow-repeat me-2"></i>Update Issue Status</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="statusForm" method="POST">
        <input type="hidden" name="_method" value="PUT">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-semibold">New Status</label>
            <select name="status" id="newStatus" class="form-select">
              <% ['Reported','Verified','In Progress','Resolved','Rejected'].forEach(s => { %>
              <option value="<%= s %>"><%= s %></option>
              <% }) %>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Comment (Optional)</label>
            <textarea name="comment" class="form-control" rows="3"
                      placeholder="Add a note about this status change..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check2 me-1"></i>Update Status
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<% const extraScripts = `
<script>
  function setIssue(id, currentStatus) {
    document.getElementById('statusForm').action = '/admin/issues/' + id + '/status?_method=PUT';
    document.getElementById('newStatus').value = currentStatus;
  }
</script>
`; %>
<%- include('../partials/footer') %>
