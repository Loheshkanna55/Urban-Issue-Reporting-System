<%- include('../partials/header') %>

<div class="page-header">
  <div>
    <h2><i class="bi bi-shield-check me-2"></i>Admin Dashboard</h2>
    <p class="text-muted">System-wide analytics & overview</p>
  </div>
</div>

<!-- Stats Cards -->
<div class="row g-3 mb-4">
  <div class="col-6 col-md-2">
    <div class="stat-card stat-total">
      <div class="stat-icon"><i class="bi bi-collection"></i></div>
      <div class="stat-number"><%= stats.total %></div>
      <div class="stat-label">Total</div>
    </div>
  </div>
  <div class="col-6 col-md-2">
    <div class="stat-card stat-reported">
      <div class="stat-icon"><i class="bi bi-flag"></i></div>
      <div class="stat-number"><%= stats.reported %></div>
      <div class="stat-label">Reported</div>
    </div>
  </div>
  <div class="col-6 col-md-2">
    <div class="stat-card" style="background:linear-gradient(135deg,#9b59b6,#8e44ad)">
      <div class="stat-icon"><i class="bi bi-check-square"></i></div>
      <div class="stat-number"><%= stats.verified %></div>
      <div class="stat-label">Verified</div>
    </div>
  </div>
  <div class="col-6 col-md-2">
    <div class="stat-card stat-progress">
      <div class="stat-icon"><i class="bi bi-arrow-repeat"></i></div>
      <div class="stat-number"><%= stats.inProgress %></div>
      <div class="stat-label">In Progress</div>
    </div>
  </div>
  <div class="col-6 col-md-2">
    <div class="stat-card stat-resolved">
      <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
      <div class="stat-number"><%= stats.resolved %></div>
      <div class="stat-label">Resolved</div>
    </div>
  </div>
  <div class="col-6 col-md-2">
    <div class="stat-card" style="background:linear-gradient(135deg,#e74c3c,#c0392b)">
      <div class="stat-icon"><i class="bi bi-x-circle"></i></div>
      <div class="stat-number"><%= stats.rejected %></div>
      <div class="stat-label">Rejected</div>
    </div>
  </div>
</div>

<div class="row g-4 mb-4">
  <!-- Monthly Chart -->
  <div class="col-md-7">
    <div class="card card-glass p-4">
      <h6 class="fw-bold mb-3"><i class="bi bi-bar-chart me-2"></i>Monthly Issue Trend</h6>
      <canvas id="monthlyChart" height="200"></canvas>
    </div>
  </div>

  <!-- Category Chart -->
  <div class="col-md-5">
    <div class="card card-glass p-4">
      <h6 class="fw-bold mb-3"><i class="bi bi-pie-chart me-2"></i>Category Distribution</h6>
      <canvas id="categoryChart" height="200"></canvas>
    </div>
  </div>
</div>

<!-- Recent Issues Table -->
<div class="card card-glass">
  <div class="card-header-custom">
    <h6 class="fw-bold mb-0"><i class="bi bi-clock-history me-2"></i>Latest Issues</h6>
    <a href="/admin/issues" class="btn btn-sm btn-outline-primary">Manage All</a>
  </div>
  <div class="table-responsive">
    <table class="table table-hover mb-0">
      <thead>
        <tr>
          <th>Issue ID</th>
          <th>Title</th>
          <th>Category</th>
          <th>Area</th>
          <th>Reporter</th>
          <th>Status</th>
          <th>Priority</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <% recentIssues.forEach(issue => { %>
        <tr>
          <td><code><%= issue.issueId %></code></td>
          <td><%= issue.title.substring(0, 30) %><%= issue.title.length > 30 ? '...' : '' %></td>
          <td><small class="badge bg-secondary"><%= issue.category %></small></td>
          <td><%= issue.area %></td>
          <td><%= issue.reportedBy ? issue.reportedBy.name : 'Unknown' %></td>
          <td><span class="status-badge status-<%= issue.status.toLowerCase().replace(/\s+/g,'-') %>"><%= issue.status %></span></td>
          <td>
            <span class="priority-badge priority-<%= issue.priorityScore >= 40 ? 'critical' : issue.priorityScore >= 25 ? 'high' : issue.priorityScore >= 15 ? 'medium' : 'low' %>">
              <%= issue.priorityScore %>
            </span>
          </td>
          <td><a href="/issues/<%= issue._id %>" class="btn btn-xs btn-outline-primary">View</a></td>
        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<% const monthlyLabels = monthlyData.map(m => {
  const months = ['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return months[m._id.month] + ' ' + m._id.year;
});
const monthlyCounts = monthlyData.map(m => m.count);
const categoryLabels = categoryStats.map(c => c._id);
const categoryCounts = categoryStats.map(c => c.count);
%>

<% const extraScripts = `
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  // Monthly Chart
  new Chart(document.getElementById('monthlyChart'), {
    type: 'bar',
    data: {
      labels: ${JSON.stringify(monthlyLabels)},
      datasets: [{
        label: 'Issues Reported',
        data: ${JSON.stringify(monthlyCounts)},
        backgroundColor: 'rgba(26,115,232,0.7)',
        borderColor: '#1a73e8',
        borderWidth: 2,
        borderRadius: 8
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
  });

  // Category Doughnut
  const colors = ['#1a73e8','#34a853','#fbbc04','#ea4335','#9c27b0','#00bcd4','#ff5722','#607d8b'];
  new Chart(document.getElementById('categoryChart'), {
    type: 'doughnut',
    data: {
      labels: ${JSON.stringify(categoryLabels)},
      datasets: [{
        data: ${JSON.stringify(categoryCounts)},
        backgroundColor: colors,
        borderWidth: 2
      }]
    },
    options: { responsive: true, cutout: '65%', plugins: { legend: { position: 'bottom', labels: { padding: 10, font: { size: 11 } } } } }
  });

  // Live socket
  const socket = io();
  socket.on('dashboard-update', (data) => {
    console.log('Live update:', data);
  });
</script>
`; %>
<%- include('../partials/footer') %>
