<%- include('../partials/header') %>

<div class="page-header">
  <div>
    <h2><i class="bi bi-list-ul me-2"></i>My Issues</h2>
    <p class="text-muted"><%= total %> total reports</p>
  </div>
  <a href="/issues/new" class="btn btn-primary">
    <i class="bi bi-plus-circle me-2"></i>Report Issue
  </a>
</div>

<!-- Filters -->
<div class="card card-glass p-3 mb-4">
  <form method="GET" action="/issues" class="row g-2 align-items-end">
    <div class="col-sm-4">
      <label class="form-label small fw-semibold">Status</label>
      <select name="status" class="form-select form-select-sm">
        <option value="">All Statuses</option>
        <% ['Reported','Verified','In Progress','Resolved','Rejected'].forEach(s => { %>
        <option value="<%= s %>" <%= currentStatus === s ? 'selected' : '' %>><%= s %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-sm-4">
      <label class="form-label small fw-semibold">Category</label>
      <select name="category" class="form-select form-select-sm">
        <option value="">All Categories</option>
        <% ['Pothole','Garbage','Water Leakage','Damaged Road','Broken Streetlight','Sewage','Encroachment','Other'].forEach(c => { %>
        <option value="<%= c %>" <%= currentCategory === c ? 'selected' : '' %>><%= c %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-sm-4 d-flex gap-2">
      <button type="submit" class="btn btn-primary btn-sm flex-fill">
        <i class="bi bi-filter me-1"></i>Filter
      </button>
      <a href="/issues" class="btn btn-outline-secondary btn-sm">Reset</a>
    </div>
  </form>
</div>

<!-- Issues List -->
<% if (issues.length === 0) { %>
<div class="empty-state py-5">
  <i class="bi bi-inbox fs-1 text-muted"></i>
  <h5 class="mt-3">No issues found</h5>
  <p class="text-muted">Try adjusting your filters or report a new issue</p>
  <a href="/issues/new" class="btn btn-primary">Report an Issue</a>
</div>
<% } else { %>
<div class="row g-3">
  <% issues.forEach(issue => { %>
  <div class="col-12">
    <div class="issue-card">
      <div class="issue-card-left">
        <div class="issue-id-badge">#<%= issue.issueId %></div>
        <span class="priority-badge priority-<%= issue.priorityScore >= 40 ? 'critical' : issue.priorityScore >= 25 ? 'high' : issue.priorityScore >= 15 ? 'medium' : 'low' %>">
          <i class="bi bi-lightning-charge me-1"></i>
          Score: <%= issue.priorityScore %>
        </span>
      </div>
      <div class="issue-card-body">
        <h6 class="issue-card-title">
          <a href="/issues/<%= issue._id %>"><%= issue.title %></a>
        </h6>
        <div class="issue-card-meta">
          <span><i class="bi bi-tag me-1"></i><%= issue.category %></span>
          <span><i class="bi bi-geo-alt me-1"></i><%= issue.area %>, <%= issue.locality %></span>
          <span><i class="bi bi-calendar me-1"></i><%= new Date(issue.createdAt).toLocaleDateString('en-IN', {day:'numeric', month:'short', year:'numeric'}) %></span>
          <span><i class="bi bi-hand-thumbs-up me-1"></i><%= issue.upvotes.length %> upvotes</span>
        </div>
        <% if (issue.images.length > 0) { %>
        <div class="issue-thumb-row">
          <% issue.images.slice(0,3).forEach(img => { %>
          <img src="<%= img %>" alt="issue" class="issue-thumb">
          <% }) %>
          <% if (issue.images.length > 3) { %>
          <span class="more-images">+<%= issue.images.length - 3 %></span>
          <% } %>
        </div>
        <% } %>
      </div>
      <div class="issue-card-right">
        <span class="status-badge status-<%= issue.status.toLowerCase().replace(/\s+/g,'-') %>">
          <%= issue.status %>
        </span>
        <a href="/issues/<%= issue._id %>" class="btn btn-sm btn-outline-primary mt-2">
          <i class="bi bi-eye me-1"></i>View
        </a>
      </div>
    </div>
  </div>
  <% }) %>
</div>

<!-- Pagination -->
<% if (totalPages > 1) { %>
<nav class="mt-4">
  <ul class="pagination justify-content-center">
    <% if (currentPage > 1) { %>
    <li class="page-item">
      <a class="page-link" href="?page=<%= currentPage-1 %>&status=<%= currentStatus %>&category=<%= currentCategory %>">
        <i class="bi bi-chevron-left"></i>
      </a>
    </li>
    <% } %>
    <% for(let i=1; i<=totalPages; i++) { %>
    <li class="page-item <%= i===currentPage ? 'active' : '' %>">
      <a class="page-link" href="?page=<%= i %>&status=<%= currentStatus %>&category=<%= currentCategory %>"><%= i %></a>
    </li>
    <% } %>
    <% if (currentPage < totalPages) { %>
    <li class="page-item">
      <a class="page-link" href="?page=<%= currentPage+1 %>&status=<%= currentStatus %>&category=<%= currentCategory %>">
        <i class="bi bi-chevron-right"></i>
      </a>
    </li>
    <% } %>
  </ul>
</nav>
<% } %>
<% } %>

<%- include('../partials/footer') %>
